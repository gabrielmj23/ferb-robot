<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Control FERB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>

  <body class="bg-gray-100 flex flex-col items-center h-screen">
    <h1 class="text-4xl font-bold mt-8 mb-6">Control del Robot FERB</h1>

    <div class="space-x-4 mb-6">
      <button
        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-700"
        onclick="setMode('manual')"
      >
        Modo Manual
      </button>
      <button
        class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-700"
        onclick="setMode('dog')"
      >
        Modo Perrito
      </button>
    </div>
    <div class="flex space-x-8 items-center">
      <img
        id="camera"
        src="/camera/stream"
        alt="Cámara del robot"
        width="480"
        class="rotate-180"
      /><br /><br />
      <div class="flex flex-col items-center space-y-4 mb-4">
        <button
          onclick="setDirection('forward')"
          class="px-10 py-4 bg-blue-500 text-white rounded hover:bg-blue-700"
        >
          ▲
        </button>
        <div class="flex space-x-6 items-center">
          <button
            onclick="setDirection('left')"
            class="px-10 py-4 bg-blue-500 text-white rounded hover:bg-blue-700"
          >
            ◀
          </button>
          <!-- Botón de Parar en el centro -->
          <button
            onclick="stopMove()"
            class="px-10 py-4 bg-red-500 text-white rounded hover:bg-red-700 font-bold"
          >
            ■
          </button>
          <button
            onclick="setDirection('right')"
            class="px-10 py-4 bg-blue-500 text-white rounded hover:bg-blue-700"
          >
            ▶
          </button>
        </div>
        <button
          onclick="setDirection('backward')"
          class="px-10 py-4 bg-blue-500 text-white rounded hover:bg-blue-700"
        >
          ▼
        </button>
      </div>
      <!-- Canvas para la brújula -->
      <div class="flex flex-col items-center">
        <canvas
          id="compassCanvas"
          width="150"
          height="150"
          class="border border-gray-400 bg-white"
        ></canvas>
        <span class="mt-2 text-gray-700">Brújula</span>
      </div>
    </div>

    <!-- Mapa del laboratorio -->
    <div class="mt-8 flex flex-col items-center">
      <h2 class="text-2xl font-semibold mb-2">Mapa del Laboratorio</h2>
      <div id="lab-map" style="width: 500px; height: 400px; border: 2px solid #888;"></div>
      <div class="mt-2 text-gray-700">
        Posición seleccionada: <span id="selected-coords">Ninguna</span>
      </div>
    </div>

    <script>
      function setDirection(direction) {
        move(direction); // Enviar la dirección solo una vez por clic
      }

      function stopMove() {
        move("stop");
      }

      function move(direction) {
        fetch("/move/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ direction: direction, speed: 1 }),
        });
      }
      function setMode(mode) {
        fetch("/mode/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: mode }),
        })
          .then((r) => r.json())
          .then((data) => {
            console.log(data);
          });
      }

      // Brújula: escuchar el stream y dibujar la flecha
      const compassCanvas = document.getElementById("compassCanvas");
      const ctx = compassCanvas.getContext("2d");
      let currentAngle = 0;

      function drawCompass(angle) {
        ctx.clearRect(0, 0, compassCanvas.width, compassCanvas.height);
        // Dibujar círculo
        ctx.beginPath();
        ctx.arc(75, 75, 60, 0, 2 * Math.PI);
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;
        ctx.stroke();
        // Dibujar N
        ctx.font = "16px Arial";
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.fillText("N", 75, 25);
        // Dibujar flecha
        ctx.save();
        ctx.translate(75, 75);
        ctx.rotate(((angle - 0) * Math.PI) / 180); // Norte = 0°
        ctx.beginPath();
        ctx.moveTo(0, -50);
        ctx.lineTo(8, 0);
        ctx.lineTo(0, -20);
        ctx.lineTo(-8, 0);
        ctx.closePath();
        ctx.fillStyle = "#e11d48";
        ctx.fill();
        ctx.restore();
        // Mostrar grados
        ctx.font = "14px Arial";
        ctx.fillStyle = "#555";
        ctx.fillText(angle.toFixed(2) + "°", 75, 140);
      }

      // Inicializar brújula
      drawCompass(0);

      // Escuchar el stream SSE
      const compassEventSource = new EventSource("/compass/stream");
      compassEventSource.onmessage = function (event) {
        const data = event.data;
        const angle = parseFloat(data);
        if (!isNaN(angle)) {
          currentAngle = angle;
          drawCompass(currentAngle);
        }
      };

      // Mapa personalizado con imagen
      const map = L.map('lab-map', {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 2,
        zoomControl: true,
      });
      // Tamaño de la imagen (ajusta a tu imagen)
      const w = 1000, h = 800; // ancho y alto en píxeles
      const imageUrl = 'lab.png'; // pon tu imagen en /static/lab.png
      const bounds = [[0,0], [h, w]];
      L.imageOverlay(imageUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      let marker;
      map.on('click', function(e) {
        const {lat, lng} = e.latlng;
        if (marker) marker.setLatLng([lat, lng]);
        else marker = L.marker([lat, lng]).addTo(map);
        // Mostrar coordenadas relativas
        document.getElementById('selected-coords').textContent = `X: ${lng.toFixed(1)}, Y: ${lat.toFixed(1)}`;
        // Aquí puedes hacer un fetch al backend para enviar la posición
        // fetch('/set_target', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({x: lng, y: lat}) });
      });
    </script>
  </body>
</html>
